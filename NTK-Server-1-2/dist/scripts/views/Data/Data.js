define(["backbone","rivets","views/item/WidgetMulti","text!./template.js","utils/SignalChainFunctions","utils/SignalChainClasses","jqueryknob"],function(e,t,a,n){return a.extend({ins:[{title:"in",to:"inTrigger"},{title:"index",to:"inIndex"}],outs:[{title:"out",from:"dataOut",to:"out"}],widgetEvents:{"click .dataIndex":"nextElement","change .orderType":"setOrder","change .database":"resetData","change .dataTypeNum":"resetData","change .dataTypeText":"resetData","change .numericMax":"resetData","change .numericMin":"resetData","change .delimiter":"resetData"},typeID:"Data",className:"data",categories:["generator"],template:_.template(n),initialize:function(e){a.prototype.initialize.call(this,e),this.model.set({title:"Data",inTrigger:0,inIndex:0,database:"apple,banana,cherry,date,elderberry,fig,grape,huckleberry",orderType:"ordered",rangeMin:512,rangeMax:1023,segments:1,lastSegment:-1,dataType:"text",delimiter:",",dataOut:"",out:"",dataIndex:"",numericMin:0,numericMax:1023,orderedDatabase:"",elements:[],elementIndexes:[],currentElement:0}),this.widgetReady=!1},onRender:function(){a.prototype.onRender.call(this),app.server||this.$(".dataIndex").css("cursor","pointer"),this.widgetReady=!0,this.model.set("dataOut",""),this.buildDatabase(),this.setOrder()},onModelChange:function(e){if(this.widgetReady){if(void 0!==e.changedAttributes().inTrigger){var t=parseFloat(this.model.get("inTrigger"),10),a=parseFloat(this.model.get("rangeMin"),10),n=parseFloat(this.model.get("rangeMax"),10)+1,i=parseInt(this.model.get("segments"),10),s=(n-a)/i,d=Math.floor((t-a)/s);d>=0&&i>d&&d!=this.model.get("lastSegment")&&this.nextElement(),this.model.set("lastSegment",d)}void 0!==e.changedAttributes().inIndex&&this.indexElement(parseInt(this.model.get("inIndex"),10))}},resetData:function(){this.buildDatabase(),this.setOrder(!0)},setOrder:function(e){if(this.widgetReady){e="undefined"!=typeof e?e:!0;var t=this.model.get("orderType");this.model.set("elementIndexes",[]);for(var a=0;a<this.model.get("elements").length;a++)this.model.get("elementIndexes").push(a);var n=this.model.get("elementIndexes");switch(t){case"ordered":break;case"reverse":n.reverse();break;case"randomFull":this.shuffle(n);break;case"randomNoRepeat":this.randomize(n,!0);break;case"randomAny":this.randomize(n,!1)}this.model.set("currentElement",0);for(var i="",a=0;a<this.model.get("elementIndexes").length;a++)i+=a+") "+this.model.get("elements")[this.model.get("elementIndexes")[a]]+"\n";this.model.set("orderedDatabase",i),e&&this.model.set("dataIndex","-- of "+(this.model.get("elements").length-1))}},indexElement:function(e){if(e>=0&&e<this.model.get("elementIndexes").length){var t=this.model.get("elementIndexes")[e];void 0===t&&(t=0);var a=this.model.get("elements")[t];this.model.set("dataOut",a),this.model.set("dataIndex",t+" of "+(this.model.get("elements").length-1))}},nextElement:function(){var e=this.model.get("currentElement"),t=this.model.get("elementIndexes")[e];void 0===t&&(t=0);var a=this.model.get("elements")[t];this.model.set("dataOut",a),this.model.set("dataIndex",t+" of "+(this.model.get("elements").length-1)),e+=1,e>=this.model.get("elements").length?(this.setOrder(!1),this.model.set("currentElement",0)):this.model.set("currentElement",e)},buildDatabase:function(){if(this.widgetReady)if("text"==this.model.get("dataType")){var e=this.model.get("delimiter"),t=this.model.get("database");t=t.replace(/(\r\n|\n|\r)/gm,"\n"),"\\n"==this.model.get("delimiter")&&(e="\n"),this.model.set("elements",t.split(e))}else if("number"==this.model.get("dataType")){this.model.set("elements",[]);for(var a=parseInt(this.model.get("numericMin"),10);a<=parseInt(this.model.get("numericMax"),10);a++)this.model.get("elements").push(a)}},shuffle:function(e){for(var t=e.length-1;t>0;t--){var a=Math.floor(Math.random()*(t+1)),n=e[a];e[a]=e[t],e[t]=n}return e},randomize:function(e,t){var a=e.slice(),n=e.length;e[0]=a[Math.floor(Math.random()*n)];for(var i=1;n>i;i++)if(t){do e[i]=a[Math.floor(Math.random()*n)];while(e[i]==e[i-1])}else e[i]=a[Math.floor(Math.random()*n)];return e}})});