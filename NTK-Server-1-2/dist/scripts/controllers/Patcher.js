define(["application","backbone","communicator","SocketAdapter","cableManager","controllers/PatchLoader","controllers/Timing","views/composite/Widgets","collections/Widgets","models/ArduinoUno","models/ModelMap","views/WidgetMap","models/WidgetConfig","models/OSC","views/AnalogIn/AnalogIn","views/AnalogOut/AnalogOut","views/DigitalIn/DigitalIn","views/DigitalOut/DigitalOut","views/Image/Image","views/Code/Code","views/Blank/Blank","views/Servo/Servo","views/OSCIn/OSCIn","views/OSCOut/OSCOut","views/Splitter/Splitter","views/item/RestrictiveOverlay"],function(e,i,t,n,d,o,a,s,r,p,g,l,w,h,v,u,c,m,M,f,I,W,T,F,S,O){var D=function(e){this.parentRegion=e,this.views.mainCanvas=new s,this.widgetModels=new r,this.hardwareModelInstances={},this.patchLoader=new o({serverAddress:"localhost",addFunction:this.onExternalAddWidget.bind(this),mapFunction:this.mapToModel.bind(this)}),window.OO=this};return D.prototype={views:{},widgets:[],widgetMappings:[],hardwareModelInstances:{},largestCID:1,initialize:function(){this.attachMainViews()},attachMainViews:function(){window.app.timingController=new a,t.socketAdapter=new n,this.parentRegion&&(this.parentRegion.show(this.views.mainCanvas),$("#patcherRegion").append((new O).render().el)),this.addEventListeners()},addEventListeners:function(){window.app.vent.on("ToolBar:addWidget",this.onExternalAddWidget,this),window.app.vent.on("ToolBar:savePatch",this.savePatch,this),window.app.vent.on("ToolBar:loadPatch",this.loadPatch,this),window.app.vent.on("ToolBar:clearPatch",this.clearPatch,this),window.app.vent.on("receivedDeviceModelUpdate",function(e){e=JSON.parse(e);var i=window.location.host,t=this.hardwareModelInstances[e.modelType+":"+i];t&&t.model.set(e.field,e.value)},this),window.app.cableManager=new d,$(window.app.cableManager.parentEl).css({top:0,left:0,position:"absolute",width:"100%",height:"100%"}),window.app.vent.on("Widget:removeMapping",this.removeMappingFromWidget,this),window.app.vent.on("updateWidgetModelFromServer",this.updateWidgetModelFromServer,this),window.app.vent.on("updateWidgetMappingFromServer",this.updateWidgetMappingFromServer,this)},onExternalAddWidget:function(e,i){var t,n=window.location.host,d=new w;if(this.widgetModels.add(d),e){if("AnalogIn"===e){var t=new v({model:d,inputMapping:"A0"});return this.addWidgetToStage(t,i),i||this.mapToModel({view:t,modelType:"ArduinoUno",IOMapping:{sourceField:"A0",destinationField:"in"},server:n},i),t}if("AnalogOut"===e){var o="D3",a=this.existingMappingExists(o),s=a?"":o,t=new u({model:d,outputMapping:s});return this.addWidgetToStage(t,i),i||this.mapToModel({view:t,IOMapping:{sourceField:"out",destinationField:s},modelType:"ArduinoUno",server:n},i),t}if("DigitalIn"===e){var t=new c({model:d,inputMapping:"D12"});return this.addWidgetToStage(t,i),i||this.mapToModel({view:t,modelType:"ArduinoUno",IOMapping:{sourceField:"D12",destinationField:"in"},server:n},i),t}if("DigitalOut"===e){var o="D3",a=this.existingMappingExists(o),s=a?"":o,t=new m({model:d,outputMapping:s});return this.addWidgetToStage(t,i),i||this.mapToModel({view:t,IOMapping:{sourceField:"out",destinationField:s},modelType:"ArduinoUno",server:n},i),t}if("Servo"===e){var o="",a=_.find(this.widgetMappings,function(e){return e.map.destinationField===o}),s=a?"":o,t=new W({model:d,outputMapping:s});return this.addWidgetToStage(t,i),i||this.mapToModel({view:t,IOMapping:{sourceField:"out",destinationField:o},modelType:"ArduinoUno",server:n},i),t}if("OSCIn"===e){var t=new T({model:d,inputMapping:"/ntk/in/1"});return this.addWidgetToStage(t,i),i||this.mapToModel({view:t,modelType:"OSC",IOMapping:{sourceField:"/ntk/in/1",destinationField:"in"},server:n},i),t}if("OSCOut"===e){var o="/ntk/out/1:127.0.0.1:57120",a=_.find(this.widgetMappings,function(e){return e.map.destinationField===o}),s=a?"":o,t=new F({model:d,outputMapping:s});return this.addWidgetToStage(t,i),i||this.mapToModel({view:t,IOMapping:{sourceField:"out",destinationField:s},modelType:"OSC",server:n},i),t}var t=new l[e]({model:d});return this.addWidgetToStage(t,i),t}return!1},existingMappingExists:function(e){var i=_.find(this.widgetMappings,function(i){return i.map.destinationField===e});return i},addWidgetToStage:function(e,i){return this.views.mainCanvas.addView(e),this.widgets.push(e),e.model.get("wid")||(this.largestCID++,e.model.set("wid","n"+this.largestCID)),i||window.app.vent.trigger("addWidget",e.model),this.widgetModels.add(e.model),this.bindModelToServer(e.model),e},updateWidgetModelFromServer:function(e){for(var i,t,n=e.length-1;n>=0;n--){var d=e[n];i=d.wid,d.changedAttributes&&(t=d.changedAttributes);var o=this.widgetModels.where({wid:i});if(o.length){var a=!0;o[0].set(t,{updateNoTrigger:a})}}},bindModelToServer:function(e){e.on("change",function(e,i){i.updateNoTrigger!==!0&&window.app.vent.trigger("widgetUpdate",{wid:e.get("wid"),changedAttributes:e.changedAttributes()})})},updateWidgetMappingFromServer:function(e){var i=_.find(this.widgets,function(i){return i.model.get("wid")==e.modelWID});if(i){var t=i.sources[0];t.map.destinationField=e.map.destinationField,t.map.sourceField=e.map.sourceField}},removeWidget:function(e,i){this.widgets=_.reject(this.widgets,function(i){return e===i}),this.widgetModels.remove(e.model);for(var t=e.model.get("wid"),n=_.filter(this.widgetMappings,function(e){return e.modelWID==t||e.viewWID==t}),d=n.length-1;d>=0;d--)this.removeMapping(n[d],e.model.get("wid"));i||window.app.vent.trigger("removeWidget",e.model.get("wid"))},mapToModel:function(e,i){var t=e.modelType,n=e.model,d=e.IOMapping,o=e.view,a=e.server,s=e.inletOffsets;if(o&&(viewWID=o.model.get("wid")),n){var r={model:n,map:d};if(s){for(var p=window.app.cableManager.createConnection({from:{x:n.get("offsetLeft")+s.source.x,y:n.get("offsetTop")+s.source.y},to:{x:o.model.get("offsetLeft")+s.destination.x,y:o.model.get("offsetTop")+s.destination.y}}),g=void 0,l=this.widgets.length-1;l>=0;l--)this.widgets[l].model.cid==n.cid&&(g=this.widgets[l].cid);o.addCable(p,n,s,d,g),n.on("remove destroy",function(){o.removeCable(p)})}var w=r.model.get("wid");this.widgetMappings.push({viewWID:viewWID,map:r.map,modelWID:w,offsets:s})}else{var h=this.getHardwareModelInstance(t,a),r={model:h,map:d};this.widgetMappings.push({viewWID:viewWID,map:r.map,modelWID:t,offsets:s})}return o&&(o.addInputMap(r),o.render(),i||window.app.vent.trigger("updateModelMappings",this.widgetMappings)),this},removeMappingFromWidget:function(e,i){var t=_.find(this.widgetMappings,function(t){return t.viewWID==i&&t.map.destinationField==e.map.destinationField&&t.map.sourceField==e.map.sourceField});t&&this.removeMapping(t)},removeMapping:function(e){this.widgetMappings.splice(this.widgetMappings.indexOf(e),1),window.app.vent.trigger("updateModelMappings",this.widgetMappings)},getHardwareModelInstance:function(e,i){var t=e+":"+i;if(this.hardwareModelInstances[t])return this.hardwareModelInstances[t].model;var n=new g[e];return this.hardwareModelInstances[t]={model:n,server:i},n.on("change",function(i){var t=i.changedAttributes();for(attribute in t)void 0!==n.attributes.outputs[attribute]&&window.app.vent.trigger("sendDeviceModelUpdate",{modelType:e,model:t})}),n},loadPatch:function(e,i){this.widgetMappings.length=0;for(var t=this.widgets.length-1;t>=0;t--)this.widgets[t].removeWidget(null,!0);this.widgets.length=0,this.patchLoader.loadJSON(e,i)},savePatch:function(){window.app.vent.trigger("savePatchToServer",{collection:this.widgetModels,mappings:this.widgetMappings})},clearPatch:function(){var e={widgets:[],mappings:[]};window.app.vent.trigger("clearPatch",{patch:e})}},D});