/*
 *  Copyright 2011 Twitter, Inc.
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */

!function(n){function t(n){"}"===n.n.substr(n.n.length-1)&&(n.n=n.n.substring(0,n.n.length-1))}function r(n){return n.trim?n.trim():n.replace(/^\s*|\s*$/g,"")}function e(n,t,r){if(t.charAt(r)!=n.charAt(0))return!1;for(var e=1,i=n.length;i>e;e++)if(t.charAt(r+e)!=n.charAt(e))return!1;return!0}function i(n,t,r,e){for(var o=[],a=null,g=null;n.length>0;)if(g=n.shift(),"#"==g.tag||"^"==g.tag||u(g,e))r.push(g),g.nodes=i(n,g.tag,r,e),o.push(g);else{if("/"==g.tag){if(0===r.length)throw new Error("Closing tag without opener: /"+g.n);if(a=r.pop(),g.n!=a.n&&!c(g.n,a.n,e))throw new Error("Nesting error: "+a.n+" vs. "+g.n);return a.end=g.i,o}o.push(g)}if(r.length>0)throw new Error("missing closing tag: "+r.pop().n);return o}function u(n,t){for(var r=0,e=t.length;e>r;r++)if(t[r].o==n.n)return n.tag="#",!0}function c(n,t,r){for(var e=0,i=r.length;i>e;e++)if(r[e].c==n&&r[e].o==t)return!0}function o(n){return'i = i || "";var b = i + "";var _ = this;'+f(n)+"return b;"}function a(n){return n.replace(m,"\\\\").replace(d,'\\"').replace(w,"\\n").replace(A,"\\r")}function g(n){return~n.indexOf(".")?"d":"f"}function f(n){for(var t="",r=0,e=n.length;e>r;r++){var i=n[r].tag;"#"==i?t+=h(n[r].nodes,n[r].n,g(n[r].n),n[r].i,n[r].end,n[r].otag+" "+n[r].ctag):"^"==i?t+=s(n[r].nodes,n[r].n,g(n[r].n)):"<"==i||">"==i?t+=l(n[r]):"{"==i||"&"==i?t+=p(n[r].n,g(n[r].n)):"\n"==i?t+=_('"\\n"'+(n.length-1==r?"":" + i")):"_v"==i?t+=v(n[r].n,g(n[r].n)):void 0===i&&(t+=_('"'+a(n[r])+'"'))}return t}function h(n,t,r,e,i,u){return"if(_.s(_."+r+'("'+a(t)+'",c,p,1),c,p,0,'+e+","+i+', "'+u+'")){b += _.rs(c,p,function(c,p){ var b = "";'+f(n)+'return b;});c.pop();}else{b += _.b; _.b = ""};'}function s(n,t,r){return"if (!_.s(_."+r+'("'+a(t)+'",c,p,1),c,p,1,0,0,"")){'+f(n)+"};"}function l(n){return'b += _.rp("'+a(n.n)+'",c,p,"'+(n.indent||"")+'");'}function p(n,t){return"b += (_."+t+'("'+a(n)+'",c,p,0));'}function v(n,t){return"b += (_.v(_."+t+'("'+a(n)+'",c,p,0)));'}function _(n){return"b += "+n+";"}var b=/\S/,d=/\"/g,w=/\n/g,A=/\r/g,m=/\\/g,x={"#":1,"^":2,"/":3,"!":4,">":5,"<":6,"=":7,_v:8,"{":9,"&":10};n.scan=function(n,i){function u(){_.length>0&&(d.push(new String(_)),_="")}function c(){for(var n=!0,t=m;t<d.length;t++)if(n=d[t].tag&&x[d[t].tag]<x._v||!d[t].tag&&null===d[t].match(b),!n)return!1;return n}function o(n,t){if(u(),n&&c())for(var r,e=m;e<d.length;e++)d[e].tag||((r=d[e+1])&&">"==r.tag&&(r.indent=d[e].toString()),d.splice(e,1));else t||d.push({tag:"\n"});w=!1,m=d.length}function a(n,t){var e="="+E,i=n.indexOf(e,t),u=r(n.substring(n.indexOf("=",t)+1,i)).split(" ");return S=u[0],E=u[1],i+e.length-1}var g=n.length,f=0,h=1,s=2,l=f,p=null,v=null,_="",d=[],w=!1,A=0,m=0,S="{{",E="}}";for(i&&(i=i.split(" "),S=i[0],E=i[1]),A=0;g>A;A++)l==f?e(S,n,A)?(--A,u(),l=h):"\n"==n.charAt(A)?o(w):_+=n.charAt(A):l==h?(A+=S.length-1,v=x[n.charAt(A+1)],p=v?n.charAt(A+1):"_v","="==p?(A=a(n,A),l=f):(v&&A++,l=s),w=A):e(E,n,A)?(d.push({tag:p,n:r(_),otag:S,ctag:E,i:"/"==p?w-E.length:A+S.length}),_="",A+=E.length-1,l=f,"{"==p&&("}}"==E?A++:t(d[d.length-1]))):_+=n.charAt(A);return o(w,!0),d},n.generate=function(t,r,e){return e.asString?"function(c,p,i){"+t+";}":new n.Template(new Function("c","p","i",t),r,n)},n.parse=function(n,t){return t=t||{},i(n,"",[],t.sectionTags||[])},n.cache={},n.compile=function(n,t){t=t||{};var r=n+"||"+!!t.asString,e=this.cache[r];return e?e:(e=this.generate(o(this.parse(this.scan(n,t.delimiters),t)),n,t),this.cache[r]=e)}}("undefined"!=typeof exports?exports:Hogan);