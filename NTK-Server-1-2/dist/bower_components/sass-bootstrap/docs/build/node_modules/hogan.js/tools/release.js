/*
 *  Copyright 2011 Twitter, Inc.
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */

function read(e){return fs.readFileSync(e).toString()}function copy(e,r){return fs.writeFileSync(r,read(e))}function uglify(e,r){var a=require("uglify-js").parser,i=require("uglify-js").uglify,n=read(e),t=a.parse(n);t=i.ast_mangle(t),t=i.ast_squeeze(t),fs.writeFileSync(r,minlicense+i.gen_code(t))}function removeFirstComment(e){return e.substring(e.indexOf("*/")+2)}var fs=require("fs"),path=require("path"),Hogan=require(__dirname+"/../lib/hogan"),minlicense="/**\n* @preserve Copyright 2012 Twitter, Inc.\n* @license http://www.apache.org/licenses/LICENSE-2.0.txt\n*/\n",packageJSON=JSON.parse(read("package.json")),version=packageJSON.version.substring(0,packageJSON.version.indexOf("-")),context={template:removeFirstComment(read(__dirname+"/../lib/template.js")),compiler:removeFirstComment(read(__dirname+"/../lib/compiler.js"))},wrapperPath="/../wrappers/",wrappers=fs.readdirSync(__dirname+wrapperPath).map(function(e){return __dirname+wrapperPath+e}),distPath=__dirname+"/../dist/";wrappers.forEach(function(e){var r=path.basename(e,".mustache"),a=distPath+"hogan-"+version+"."+r,i=distPath+"hogan-"+version+".min."+r;fs.writeFileSync(a,Hogan.compile(read(e)).render(context)),uglify(a,i)});var templateTarget=distPath+"template-"+version+".js";fs.writeFileSync(templateTarget,read(__dirname+"/../lib/template.js")),uglify(templateTarget,distPath+"template-"+version+".min.js"),packageJSON.version=version,fs.writeFileSync(__dirname+"/../dist/nodejs/package.json",JSON.stringify(packageJSON,null,"  "));