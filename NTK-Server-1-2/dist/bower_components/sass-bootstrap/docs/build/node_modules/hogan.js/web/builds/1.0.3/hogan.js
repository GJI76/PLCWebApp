/*
 *  Copyright 2011 Twitter, Inc.
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */

var HoganTemplate=function(){function n(n){this.text=n}function t(n){return n=String(null===n?"":n),c.test(n)?n.replace(r,"&amp;").replace(e,"&lt;").replace(i,"&gt;").replace(o,"&#39;").replace(u,"&quot;"):n}n.prototype={r:function(){return""},v:t,render:function(n,t,r){return this.r(n,t,r)},rp:function(n,t,r,e){var i=r[n];return i?i.r(t,r,e):""},rs:function(n,t,r){var e="",i=n[n.length-1];if(!a(i))return e=r(n,t);for(var o=0;o<i.length;o++)n.push(i[o]),e+=r(n,t),n.pop();return e},s:function(n,t,r,e,i,o,u){var c;return a(n)&&0===n.length?!1:(e||"function"!=typeof n||(n=this.ls(n,t,r,i,o,u)),c=""===n||!!n,!e&&c&&t&&t.push("object"==typeof n?n:t[t.length-1]),c)},d:function(n,t,r,e){var i=n.split("."),o=this.f(i[0],t,r,e),u=null;if("."===n&&a(t[t.length-2]))return t[t.length-1];for(var c=1;c<i.length;c++)o&&"object"==typeof o&&i[c]in o?(u=o,o=o[i[c]]):o="";return e&&!o?!1:(e||"function"!=typeof o||(t.push(u),o=this.lv(o,t,r),t.pop()),o)},f:function(n,t,r,e){for(var i=!1,o=null,u=!1,c=t.length-1;c>=0;c--)if(o=t[c],o&&"object"==typeof o&&n in o){i=o[n],u=!0;break}return u?(e||"function"!=typeof i||(i=this.lv(i,t,r)),i):e?!1:""},ho:function(n,t,r,e,i){var o=n.call(t,e,function(n){return Hogan.compile(n,{delimiters:i}).render(t,r)}),u=Hogan.compile(o.toString(),{delimiters:i}).render(t,r);return this.b=u,!1},b:"",ls:function(n,t,r,e,i,o){var u=t[t.length-1],c=n.call(u);return n.length>0?this.ho(n,u,r,this.text.substring(e,i),o):"function"==typeof c?this.ho(c,u,r,this.text.substring(e,i),o):c},lv:function(n,t,r){var e=t[t.length-1];return Hogan.compile(n.call(e).toString()).render(e,r)}};var r=/&/g,e=/</g,i=/>/g,o=/\'/g,u=/\"/g,c=/[&<>\"\']/,a=Array.isArray||function(n){return"[object Array]"===Object.prototype.toString.call(n)};return n}(),Hogan=function(){function n(n,e){function i(){v.length>0&&(b.push(new String(v)),v="")}function o(){for(var n=!0,t=x;t<b.length;t++)if(n=b[t].tag&&y[b[t].tag]<y._v||!b[t].tag&&null===b[t].match(d),!n)return!1;return n}function u(n,t){if(i(),n&&o())for(var r,e=x;e<b.length;e++)b[e].tag||((r=b[e+1])&&">"==r.tag&&(r.indent=b[e].toString()),b.splice(e,1));else t||b.push({tag:"\n"});m=!1,x=b.length}function c(n,r){var e="="+A,i=n.indexOf(e,r),o=t(n.substring(n.indexOf("=",r)+1,i)).split(" ");return H=o[0],A=o[1],i+e.length-1}var a=n.length,f=0,l=1,g=2,p=f,h=null,s=null,v="",b=[],m=!1,_=0,x=0,H="{{",A="}}";for(e&&(e=e.split(" "),H=e[0],A=e[1]),_=0;a>_;_++)p==f?r(H,n,_)?(--_,i(),p=l):"\n"==n.charAt(_)?u(m):v+=n.charAt(_):p==l?(_+=H.length-1,s=y[n.charAt(_+1)],h=s?n.charAt(_+1):"_v","="==h?(_=c(n,_),p=f):(s&&_++,p=g),m=_):r(A,n,_)?(b.push({tag:h,n:t(v),otag:H,ctag:A,i:"/"==h?m-A.length:_+H.length}),v="",_+=A.length-1,p=f,"{"==h&&_++):v+=n.charAt(_);return u(m,!0),b}function t(n){return n.trim?n.trim():n.replace(/^\s*|\s*$/g,"")}function r(n,t,r){if(t.charAt(r)!=n.charAt(0))return!1;for(var e=1,i=n.length;i>e;e++)if(t.charAt(r+e)!=n.charAt(e))return!1;return!0}function e(n,t,r,u){for(var c=[],a=null,f=null;n.length>0;)if(f=n.shift(),"#"==f.tag||"^"==f.tag||i(f,u))r.push(f),f.nodes=e(n,f.tag,r,u),c.push(f);else{if("/"==f.tag){if(0===r.length)throw new Error("Closing tag without opener: /"+f.n);if(a=r.pop(),f.n!=a.n&&!o(f.n,a.n,u))throw new Error("Nesting error: "+a.n+" vs. "+f.n);return a.end=f.i,c}c.push(f)}if(r.length>0)throw new Error("missing closing tag: "+r.pop().n);return c}function i(n,t){for(var r=0,e=t.length;e>r;r++)if(t[r].o==n.n)return n.tag="#",!0}function o(n,t,r){for(var e=0,i=r.length;i>e;e++)if(r[e].c==n&&r[e].o==t)return!0}function u(n,t,r){var e='i = i || "";var c = [cx];var b = i + "";var _ = this;'+f(n)+"return b;";if(r.asString)return"function(cx,p,i){"+e+";}";var i=new HoganTemplate(t);return i.r=new Function("cx","p","i",e),i}function c(n){return n.replace(x,"\\\\").replace(b,'\\"').replace(m,"\\n").replace(_,"\\r")}function a(n){return~n.indexOf(".")?"d":"f"}function f(n){for(var t="",r=0,e=n.length;e>r;r++){var i=n[r].tag;"#"==i?t+=l(n[r].nodes,n[r].n,a(n[r].n),n[r].i,n[r].end,n[r].otag+" "+n[r].ctag):"^"==i?t+=g(n[r].nodes,n[r].n,a(n[r].n)):"<"==i||">"==i?t+=p(n[r]):"{"==i||"&"==i?t+=h(n[r].n,a(n[r].n)):"\n"==i?t+=v('"\\n"'+(n.length-1==r?"":" + i")):"_v"==i?t+=s(n[r].n,a(n[r].n)):void 0===i&&(t+=v('"'+c(n[r])+'"'))}return t}function l(n,t,r,e,i,o){return"if(_.s(_."+r+'("'+c(t)+'",c,p,1),c,p,0,'+e+","+i+', "'+o+'")){b += _.rs(c,p,function(c,p){ var b = "";'+f(n)+'return b;});c.pop();}else{b += _.b; _.b = ""};'}function g(n,t,r){return"if (!_.s(_."+r+'("'+c(t)+'",c,p,1),c,p,1,0,0,"")){'+f(n)+"};"}function p(n){return'b += _.rp("'+c(n.n)+'",c[c.length - 1],p,"'+(n.indent||"")+'");'}function h(n,t){return"b += (_."+t+'("'+c(n)+'",c,p,0));'}function s(n,t){return"b += (_.v(_."+t+'("'+c(n)+'",c,p,0)));'}function v(n){return"b += "+n+";"}var d=/\S/,b=/\"/g,m=/\n/g,_=/\r/g,x=/\\/g,y={"#":1,"^":2,"/":3,"!":4,">":5,"<":6,"=":7,_v:8,"{":9,"&":10};return{scan:n,parse:function(n,t){return t=t||{},e(n,"",[],t.sectionTags||[])},cache:{},compile:function(t,r){r=r||{};var e=this.cache[t];return e?e:(e=u(this.parse(n(t,r.delimiters),r),t,r),this.cache[t]=e)}}}();"undefined"!=typeof module&&module.exports?(module.exports=Hogan,module.exports.Template=HoganTemplate):"function"==typeof define&&define.amd?define([],function(){return Hogan}):"undefined"!=typeof exports&&(exports.Hogan=Hogan,exports.HoganTemplate=HoganTemplate);