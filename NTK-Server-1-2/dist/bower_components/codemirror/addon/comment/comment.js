// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){function n(e){var n=e.search(i);return-1==n?0:n}var t={},i=/[^\s\u00a0]/,l=e.Pos;e.commands.toggleComment=function(e){for(var n=1/0,t=e.listSelections(),i=null,o=t.length-1;o>=0;o--){var a=t[o].from(),r=t[o].to();a.line>=n||(r.line>=n&&(r=l(n,0)),n=a.line,null==i?e.uncomment(a,r)?i="un":(e.lineComment(a,r),i="line"):"un"==i?e.uncomment(a,r):e.lineComment(a,r))}},e.defineExtension("lineComment",function(e,o,a){a||(a=t);var r=this,m=r.getModeAt(e),c=a.lineComment||m.lineComment;if(!c)return void((a.blockCommentStart||m.blockCommentStart)&&(a.fullLines=!0,r.blockComment(e,o,a)));var f=r.getLine(e.line);if(null!=f){var g=Math.min(0!=o.ch||o.line==e.line?o.line+1:o.line,r.lastLine()+1),d=null==a.padding?" ":a.padding,s=a.commentBlankLines||e.line==o.line;r.operation(function(){if(a.indent)for(var t=f.slice(0,n(f)),o=e.line;g>o;++o){var m=r.getLine(o),u=t.length;(s||i.test(m))&&(m.slice(0,u)!=t&&(u=n(m)),r.replaceRange(t+c+d,l(o,0),l(o,u)))}else for(var o=e.line;g>o;++o)(s||i.test(r.getLine(o)))&&r.replaceRange(c+d,l(o,0))})}}),e.defineExtension("blockComment",function(e,n,o){o||(o=t);var a=this,r=a.getModeAt(e),m=o.blockCommentStart||r.blockCommentStart,c=o.blockCommentEnd||r.blockCommentEnd;if(!m||!c)return void((o.lineComment||r.lineComment)&&0!=o.fullLines&&a.lineComment(e,n,o));var f=Math.min(n.line,a.lastLine());f!=e.line&&0==n.ch&&i.test(a.getLine(f))&&--f;var g=null==o.padding?" ":o.padding;e.line>f||a.operation(function(){if(0!=o.fullLines){var t=i.test(a.getLine(f));a.replaceRange(g+c,l(f)),a.replaceRange(m+g,l(e.line,0));var d=o.blockCommentLead||r.blockCommentLead;if(null!=d)for(var s=e.line+1;f>=s;++s)(s!=f||t)&&a.replaceRange(d+g,l(s,0))}else a.replaceRange(c,n),a.replaceRange(m,e)})}),e.defineExtension("uncomment",function(e,n,o){o||(o=t);var a,r=this,m=r.getModeAt(e),c=Math.min(0!=n.ch||n.line==e.line?n.line:n.line-1,r.lastLine()),f=Math.min(e.line,c),g=o.lineComment||m.lineComment,d=[],s=null==o.padding?" ":o.padding;e:if(g){for(var u=f;c>=u;++u){var h=r.getLine(u),v=h.indexOf(g);if(v>-1&&!/comment/.test(r.getTokenTypeAt(l(u,v+1)))&&(v=-1),-1==v&&(u!=c||u==f)&&i.test(h))break e;if(v>-1&&i.test(h.slice(0,v)))break e;d.push(h)}if(r.operation(function(){for(var e=f;c>=e;++e){var n=d[e-f],t=n.indexOf(g),i=t+g.length;0>t||(n.slice(i,i+s.length)==s&&(i+=s.length),a=!0,r.replaceRange("",l(e,t),l(e,i)))}}),a)return!0}var p=o.blockCommentStart||m.blockCommentStart,C=o.blockCommentEnd||m.blockCommentEnd;if(!p||!C)return!1;var b=o.blockCommentLead||m.blockCommentLead,k=r.getLine(f),L=c==f?k:r.getLine(c),x=k.indexOf(p),R=L.lastIndexOf(C);if(-1==R&&f!=c&&(L=r.getLine(--c),R=L.lastIndexOf(C)),-1==x||-1==R||!/comment/.test(r.getTokenTypeAt(l(f,x+1)))||!/comment/.test(r.getTokenTypeAt(l(c,R+1))))return!1;var O=k.lastIndexOf(p,e.ch),M=-1==O?-1:k.slice(0,e.ch).indexOf(C,O+p.length);if(-1!=O&&-1!=M&&M+C.length!=e.ch)return!1;M=L.indexOf(C,n.ch);var E=L.slice(n.ch).lastIndexOf(p,M-n.ch);return O=-1==M||-1==E?-1:n.ch+E,-1!=M&&-1!=O&&O!=n.ch?!1:(r.operation(function(){r.replaceRange("",l(c,R-(s&&L.slice(R-s.length,R)==s?s.length:0)),l(c,R+C.length));var e=x+p.length;if(s&&k.slice(e,e+s.length)==s&&(e+=s.length),r.replaceRange("",l(f,x),l(f,e)),b)for(var n=f+1;c>=n;++n){var t=r.getLine(n),o=t.indexOf(b);if(-1!=o&&!i.test(t.slice(0,o))){var a=o+b.length;s&&t.slice(a,a+s.length)==s&&(a+=s.length),r.replaceRange("",l(n,o),l(n,a))}}}),!0)})});