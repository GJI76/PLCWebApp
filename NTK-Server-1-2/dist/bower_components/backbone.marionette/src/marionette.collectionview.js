Marionette.CollectionView=Marionette.View.extend({childViewEventPrefix:"childview",constructor:function(i){var e=i||{};this.sort=_.isUndefined(e.sort)?!0:e.sort,this._initChildViewStorage(),Marionette.View.apply(this,arguments),this._initialEvents(),this.initRenderBuffer()},initRenderBuffer:function(){this.elBuffer=document.createDocumentFragment(),this._bufferedChildren=[]},startBuffering:function(){this.initRenderBuffer(),this.isBuffering=!0},endBuffering:function(){this.isBuffering=!1,this._triggerBeforeShowBufferedChildren(),this.attachBuffer(this,this.elBuffer),this._triggerShowBufferedChildren(),this.initRenderBuffer()},_triggerBeforeShowBufferedChildren:function(){this._isShown&&_.invoke(this._bufferedChildren,"triggerMethod","before:show")},_triggerShowBufferedChildren:function(){this._isShown&&(_.each(this._bufferedChildren,function(i){_.isFunction(i.triggerMethod)?i.triggerMethod("show"):Marionette.triggerMethod.call(i,"show")}),this._bufferedChildren=[])},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"remove",this._onCollectionRemove),this.listenTo(this.collection,"reset",this.render),this.sort&&this.listenTo(this.collection,"sort",this._sortViews))},_onCollectionAdd:function(i){this.destroyEmptyView();var e=this.getChildView(i),t=this.collection.indexOf(i);this.addChild(i,e,t)},_onCollectionRemove:function(i){var e=this.children.findByModel(i);this.removeChildView(e),this.checkEmpty()},onShowCalled:function(){this.children.each(function(i){_.isFunction(i.triggerMethod)?i.triggerMethod("show"):Marionette.triggerMethod.call(i,"show")})},render:function(){return this._ensureViewIsIntact(),this.triggerMethod("before:render",this),this._renderChildren(),this.triggerMethod("render",this),this},_sortViews:function(){var i=this.collection.find(function(i,e){var t=this.children.findByModel(i);return t&&t._index!==e},this);i&&this.render()},_renderChildren:function(){this.destroyEmptyView(),this.destroyChildren(),this.isEmpty(this.collection)?this.showEmptyView():(this.triggerMethod("before:render:collection",this),this.startBuffering(),this.showCollection(),this.endBuffering(),this.triggerMethod("render:collection",this))},showCollection:function(){var i;this.collection.each(function(e,t){i=this.getChildView(e),this.addChild(e,i,t)},this)},showEmptyView:function(){var i=this.getEmptyView();if(i&&!this._showingEmptyView){this.triggerMethod("before:render:empty"),this._showingEmptyView=!0;var e=new Backbone.Model;this.addEmptyView(e,i),this.triggerMethod("render:empty")}},destroyEmptyView:function(){this._showingEmptyView&&(this.destroyChildren(),delete this._showingEmptyView)},getEmptyView:function(){return this.getOption("emptyView")},addEmptyView:function(i,e){var t=this.getOption("emptyViewOptions")||this.getOption("childViewOptions");_.isFunction(t)&&(t=t.call(this));var n=this.buildChildView(i,e,t);this._isShown&&this.triggerMethod.call(n,"before:show"),this.children.add(n),this.renderChildView(n,-1),this._isShown&&this.triggerMethod.call(n,"show")},getChildView:function(){var i=this.getOption("childView");return i||throwError('A "childView" must be specified',"NoChildViewError"),i},addChild:function(i,e,t){var n=this.getOption("childViewOptions");_.isFunction(n)&&(n=n.call(this,i,t));var h=this.buildChildView(i,e,n);return this._updateIndices(h,!0,t),this._addChildView(h,t),h},_updateIndices:function(i,e,t){this.sort&&(e?(i._index=t,this.children.each(function(e){e._index>=i._index&&e._index++})):this.children.each(function(e){e._index>=i._index&&e._index--}))},_addChildView:function(i,e){this.proxyChildEvents(i),this.triggerMethod("before:add:child",i),this.children.add(i),this.renderChildView(i,e),this._isShown&&!this.isBuffering&&(_.isFunction(i.triggerMethod)?i.triggerMethod("show"):Marionette.triggerMethod.call(i,"show")),this.triggerMethod("add:child",i)},renderChildView:function(i,e){i.render(),this.attachHtml(this,i,e)},buildChildView:function(i,e,t){var n=_.extend({model:i},t);return new e(n)},removeChildView:function(i){i&&(this.triggerMethod("before:remove:child",i),i.destroy?i.destroy():i.remove&&i.remove(),this.stopListening(i),this.children.remove(i),this.triggerMethod("remove:child",i),this._updateIndices(i,!1))},isEmpty:function(){return!this.collection||0===this.collection.length},checkEmpty:function(){this.isEmpty(this.collection)&&this.showEmptyView()},attachBuffer:function(i,e){i.$el.append(e)},attachHtml:function(i,e,t){i.isBuffering?(i.elBuffer.appendChild(e.el),i._bufferedChildren.push(e)):i._insertBefore(e,t)||i._insertAfter(e)},_insertBefore:function(i,e){var t,n=this.sort&&e<this.children.length-1;return n&&(t=this.children.find(function(i){return i._index===e+1})),t?(t.$el.before(i.el),!0):!1},_insertAfter:function(i){this.$el.append(i.el)},_initChildViewStorage:function(){this.children=new Backbone.ChildViewContainer},destroy:function(){this.isDestroyed||(this.triggerMethod("before:destroy:collection"),this.destroyChildren(),this.triggerMethod("destroy:collection"),Marionette.View.prototype.destroy.apply(this,arguments))},destroyChildren:function(){this.children.each(this.removeChildView,this),this.checkEmpty()},proxyChildEvents:function(i){var e=this.getOption("childViewEventPrefix");this.listenTo(i,"all",function(){var t=Array.prototype.slice.call(arguments),n=t[0],h=this.normalizeMethods(_.result(this,"childEvents"));t[0]=e+":"+n,t.splice(1,0,i),"undefined"!=typeof h&&_.isFunction(h[n])&&h[n].apply(this,t.slice(1)),this.triggerMethod.apply(this,t)},this)}});